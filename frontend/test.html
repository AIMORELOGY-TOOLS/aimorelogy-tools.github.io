<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾®ä¿¡ç™»å½•åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-section h2 {
            color: #333;
            border-bottom: 2px solid #07c160;
            padding-bottom: 10px;
        }
        
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .test-button:hover {
            background: #0056b3;
        }
        
        .status-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
        
        .log-area {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .success { border-left-color: #28a745; }
        .error { border-left-color: #dc3545; }
        .warning { border-left-color: #ffc107; }
    </style>
</head>
<body>
    <h1>ğŸ§ª å¾®ä¿¡ç™»å½•åŠŸèƒ½æµ‹è¯•</h1>
    
    <!-- åŸºç¡€åŠŸèƒ½æµ‹è¯• -->
    <div class="test-section">
        <h2>1. åŸºç¡€åŠŸèƒ½æµ‹è¯•</h2>
        <button class="test-button" onclick="testCheckStatus()">æ£€æŸ¥ç™»å½•çŠ¶æ€</button>
        <button class="test-button" onclick="testOpenLogin()">æ‰“å¼€ç™»å½•å¼¹çª—</button>
        <button class="test-button" onclick="testCloseLogin()">å…³é—­ç™»å½•å¼¹çª—</button>
        <button class="test-button" onclick="testLogout()">é€€å‡ºç™»å½•</button>
        
        <div class="status-display" id="basicTestResult">
            ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è¿›è¡Œæµ‹è¯•...
        </div>
    </div>
    
    <!-- API è¿æ¥æµ‹è¯• -->
    <div class="test-section">
        <h2>2. API è¿æ¥æµ‹è¯•</h2>
        <button class="test-button" onclick="testCreateQR()">æµ‹è¯•åˆ›å»ºäºŒç»´ç </button>
        <button class="test-button" onclick="testPollStatus()">æµ‹è¯•çŠ¶æ€è½®è¯¢</button>
        <button class="test-button" onclick="testFinalizeLogin()">æµ‹è¯•å®Œæˆç™»å½•</button>
        
        <div class="status-display" id="apiTestResult">
            ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è¿›è¡Œ API æµ‹è¯•...
        </div>
    </div>
    
    <!-- äº‹ä»¶ç›‘å¬æµ‹è¯• -->
    <div class="test-section">
        <h2>3. äº‹ä»¶ç›‘å¬æµ‹è¯•</h2>
        <button class="test-button" onclick="triggerLoginSuccess()">æ¨¡æ‹Ÿç™»å½•æˆåŠŸäº‹ä»¶</button>
        <button class="test-button" onclick="triggerLogout()">æ¨¡æ‹Ÿé€€å‡ºç™»å½•äº‹ä»¶</button>
        
        <div class="status-display" id="eventTestResult">
            äº‹ä»¶ç›‘å¬å™¨å·²å°±ç»ªï¼Œç­‰å¾…äº‹ä»¶è§¦å‘...
        </div>
    </div>
    
    <!-- å®Œæ•´ç™»å½•æµç¨‹æµ‹è¯• -->
    <div class="test-section">
        <h2>4. å®Œæ•´ç™»å½•æµç¨‹</h2>
        <button class="wechat-login-btn" onclick="WechatLogin.open()">
            <span>å¾®</span>
            å¼€å§‹å®Œæ•´ç™»å½•æµ‹è¯•
        </button>
        
        <div class="status-display" id="fullTestResult">
            ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹å®Œæ•´çš„ç™»å½•æµç¨‹æµ‹è¯•...
        </div>
    </div>
    
    <!-- æ—¥å¿—æ˜¾ç¤º -->
    <div class="test-section">
        <h2>5. æµ‹è¯•æ—¥å¿—</h2>
        <button class="test-button" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        <div class="log-area" id="testLog">æµ‹è¯•æ—¥å¿—å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...\n</div>
    </div>

    <!-- å¼•å…¥å¾®ä¿¡ç™»å½•ç»„ä»¶ -->
    <script>
        const API_BASE_URL = 'https://aimorelogybackend.site';
    </script>
    <script src="wechat-login-component.js"></script>
    
    <script>
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logArea = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            logArea.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('testLog').textContent = 'æµ‹è¯•æ—¥å¿—å·²æ¸…ç©º...\n';
        }
        
        // åŸºç¡€åŠŸèƒ½æµ‹è¯•
        function testCheckStatus() {
            try {
                const status = WechatLogin.checkStatus();
                const result = document.getElementById('basicTestResult');
                
                if (status.isLoggedIn) {
                    result.innerHTML = `
                        <strong>âœ… å·²ç™»å½•</strong><br>
                        OpenID: ${status.openid}<br>
                        Token: ${status.token.substring(0, 20)}...<br>
                        ç™»å½•æ—¶é—´: ${new Date(status.loginTime).toLocaleString()}
                    `;
                    result.className = 'status-display success';
                    log('æ£€æŸ¥ç™»å½•çŠ¶æ€: å·²ç™»å½•', 'success');
                } else {
                    result.innerHTML = '<strong>âŒ æœªç™»å½•</strong>';
                    result.className = 'status-display warning';
                    log('æ£€æŸ¥ç™»å½•çŠ¶æ€: æœªç™»å½•', 'warning');
                }
            } catch (error) {
                log(`æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function testOpenLogin() {
            try {
                WechatLogin.open();
                document.getElementById('basicTestResult').innerHTML = '<strong>âœ… ç™»å½•å¼¹çª—å·²æ‰“å¼€</strong>';
                document.getElementById('basicTestResult').className = 'status-display success';
                log('æ‰“å¼€ç™»å½•å¼¹çª—: æˆåŠŸ', 'success');
            } catch (error) {
                log(`æ‰“å¼€ç™»å½•å¼¹çª—å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function testCloseLogin() {
            try {
                WechatLogin.close();
                document.getElementById('basicTestResult').innerHTML = '<strong>âœ… ç™»å½•å¼¹çª—å·²å…³é—­</strong>';
                document.getElementById('basicTestResult').className = 'status-display success';
                log('å…³é—­ç™»å½•å¼¹çª—: æˆåŠŸ', 'success');
            } catch (error) {
                log(`å…³é—­ç™»å½•å¼¹çª—å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function testLogout() {
            try {
                WechatLogin.logout();
                document.getElementById('basicTestResult').innerHTML = '<strong>âœ… å·²é€€å‡ºç™»å½•</strong>';
                document.getElementById('basicTestResult').className = 'status-display success';
                log('é€€å‡ºç™»å½•: æˆåŠŸ', 'success');
            } catch (error) {
                log(`é€€å‡ºç™»å½•å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // API æµ‹è¯•
        async function testCreateQR() {
            const result = document.getElementById('apiTestResult');
            result.innerHTML = '<strong>ğŸ”„ æ­£åœ¨æµ‹è¯•åˆ›å»ºäºŒç»´ç ...</strong>';
            result.className = 'status-display';
            
            try {
                const response = await fetch(`${API_BASE_URL}/create_qr`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.sessionId && data.qrUrl) {
                    result.innerHTML = `
                        <strong>âœ… åˆ›å»ºäºŒç»´ç æˆåŠŸ</strong><br>
                        Session ID: ${data.sessionId}<br>
                        è¿‡æœŸæ—¶é—´: ${data.expireSeconds}ç§’
                    `;
                    result.className = 'status-display success';
                    log('APIæµ‹è¯• - åˆ›å»ºäºŒç»´ç : æˆåŠŸ', 'success');
                } else {
                    throw new Error(data.error || 'è¿”å›æ•°æ®æ ¼å¼é”™è¯¯');
                }
            } catch (error) {
                result.innerHTML = `<strong>âŒ åˆ›å»ºäºŒç»´ç å¤±è´¥</strong><br>${error.message}`;
                result.className = 'status-display error';
                log(`APIæµ‹è¯• - åˆ›å»ºäºŒç»´ç å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function testPollStatus() {
            const result = document.getElementById('apiTestResult');
            result.innerHTML = '<strong>ğŸ”„ æ­£åœ¨æµ‹è¯•çŠ¶æ€è½®è¯¢...</strong>';
            result.className = 'status-display';
            
            try {
                // ä½¿ç”¨ä¸€ä¸ªæµ‹è¯•ç”¨çš„ session ID
                const testSessionId = 'test-session-id';
                const response = await fetch(`${API_BASE_URL}/poll?id=${testSessionId}`);
                const data = await response.json();
                
                result.innerHTML = `
                    <strong>âœ… çŠ¶æ€è½®è¯¢æˆåŠŸ</strong><br>
                    çŠ¶æ€: ${data.status || 'pending'}<br>
                    å“åº”æ—¶é—´: ${new Date().toLocaleTimeString()}
                `;
                result.className = 'status-display success';
                log('APIæµ‹è¯• - çŠ¶æ€è½®è¯¢: æˆåŠŸ', 'success');
            } catch (error) {
                result.innerHTML = `<strong>âŒ çŠ¶æ€è½®è¯¢å¤±è´¥</strong><br>${error.message}`;
                result.className = 'status-display error';
                log(`APIæµ‹è¯• - çŠ¶æ€è½®è¯¢å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function testFinalizeLogin() {
            const result = document.getElementById('apiTestResult');
            result.innerHTML = '<strong>ğŸ”„ æ­£åœ¨æµ‹è¯•å®Œæˆç™»å½•...</strong>';
            result.className = 'status-display';
            
            try {
                const response = await fetch(`${API_BASE_URL}/finalize_login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId: 'test-session-id' })
                });
                
                const data = await response.json();
                
                if (data.success === false) {
                    result.innerHTML = `
                        <strong>âš ï¸ å®Œæˆç™»å½•æ¥å£æ­£å¸¸</strong><br>
                        è¿”å›: ${data.error || 'ç™»å½•æœªå®Œæˆ'}<br>
                        (è¿™æ˜¯æ­£å¸¸çš„ï¼Œå› ä¸ºä½¿ç”¨äº†æµ‹è¯• Session ID)
                    `;
                    result.className = 'status-display warning';
                    log('APIæµ‹è¯• - å®Œæˆç™»å½•æ¥å£: æ­£å¸¸å“åº”', 'success');
                } else {
                    result.innerHTML = `<strong>âœ… å®Œæˆç™»å½•æˆåŠŸ</strong><br>Token: ${data.token}`;
                    result.className = 'status-display success';
                    log('APIæµ‹è¯• - å®Œæˆç™»å½•: æˆåŠŸ', 'success');
                }
            } catch (error) {
                result.innerHTML = `<strong>âŒ å®Œæˆç™»å½•å¤±è´¥</strong><br>${error.message}`;
                result.className = 'status-display error';
                log(`APIæµ‹è¯• - å®Œæˆç™»å½•å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // äº‹ä»¶æµ‹è¯•
        function triggerLoginSuccess() {
            const event = new CustomEvent('wechatLoginSuccess', {
                detail: {
                    token: 'test-token-' + Date.now(),
                    openid: 'test-openid',
                    loginTime: new Date().toISOString()
                }
            });
            window.dispatchEvent(event);
            log('è§¦å‘ç™»å½•æˆåŠŸäº‹ä»¶: å®Œæˆ', 'success');
        }
        
        function triggerLogout() {
            const event = new CustomEvent('wechatLogout');
            window.dispatchEvent(event);
            log('è§¦å‘é€€å‡ºç™»å½•äº‹ä»¶: å®Œæˆ', 'success');
        }
        
        // äº‹ä»¶ç›‘å¬å™¨
        window.addEventListener('wechatLoginSuccess', function(event) {
            const result = document.getElementById('eventTestResult');
            result.innerHTML = `
                <strong>âœ… ç™»å½•æˆåŠŸäº‹ä»¶å·²è§¦å‘</strong><br>
                Token: ${event.detail.token}<br>
                OpenID: ${event.detail.openid}<br>
                æ—¶é—´: ${new Date(event.detail.loginTime).toLocaleString()}
            `;
            result.className = 'status-display success';
            log('äº‹ä»¶ç›‘å¬ - ç™»å½•æˆåŠŸ: å·²æ¥æ”¶', 'success');
        });
        
        window.addEventListener('wechatLogout', function() {
            const result = document.getElementById('eventTestResult');
            result.innerHTML = '<strong>âœ… é€€å‡ºç™»å½•äº‹ä»¶å·²è§¦å‘</strong>';
            result.className = 'status-display success';
            log('äº‹ä»¶ç›‘å¬ - é€€å‡ºç™»å½•: å·²æ¥æ”¶', 'success');
        });
        
        // é¡µé¢åŠ è½½å®Œæˆ
        window.addEventListener('load', function() {
            log('æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ', 'success');
            log(`API åœ°å€: ${API_BASE_URL}`, 'info');
            log(`å¾®ä¿¡ç™»å½•ç»„ä»¶ç‰ˆæœ¬: ${WechatLogin.version || 'æœªçŸ¥'}`, 'info');
            
            // è‡ªåŠ¨æ£€æŸ¥ç™»å½•çŠ¶æ€
            setTimeout(testCheckStatus, 1000);
        });
    </script>
</body>
</html>