<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登录状态修复测试</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .title {
            font-size: 28px;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 16px;
        }

        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 2px solid #f0f0f0;
            border-radius: 12px;
            background: #fafafa;
        }

        .test-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        .login-container {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
        }

        .status-info {
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info-neutral {
            background: #e2e3e5;
            color: #383d41;
            border: 1px solid #d6d8db;
        }

        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #0056b3;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .log-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">🔧 登录状态修复测试</div>
            <div class="subtitle">测试Token验证修复是否生效</div>
        </div>

        <!-- 登录模块测试 -->
        <div class="test-section">
            <div class="test-title">1. 微信登录模块测试</div>
            <div class="login-container" id="wechat-login-container">
                <!-- 微信登录组件将在这里渲染 -->
            </div>
            
            <div class="status-info status-info-neutral" id="login-status">
                等待登录模块初始化...
            </div>

            <button class="btn" onclick="checkCurrentLoginStatus()">检查当前登录状态</button>
            <button class="btn btn-success" onclick="testTokenValidation()">测试Token验证</button>
            <button class="btn btn-danger" onclick="clearLoginData()">清除登录数据</button>
        </div>

        <!-- Token验证测试 -->
        <div class="test-section">
            <div class="test-title">2. Token验证详细测试</div>
            <div class="status-info status-info-neutral" id="token-test-status">
                点击下方按钮开始测试...
            </div>

            <button class="btn" onclick="testTokenEncoding()">测试Token编码</button>
            <button class="btn" onclick="testDirectValidation()">直接验证API</button>
            <button class="btn" onclick="simulateLoginFlow()">模拟完整登录流程</button>
        </div>

        <!-- 日志输出 -->
        <div class="test-section">
            <div class="test-title">3. 详细日志输出</div>
            <div class="log-output" id="log-output">
                测试日志将在这里显示...
            </div>
            <button class="btn" onclick="clearLogs()">清除日志</button>
        </div>
    </div>

    <!-- 引入微信登录模块 -->
    <script src="sections/wechat-login.js"></script>
    
    <script>
        let wechatLogin;
        let logOutput = document.getElementById('log-output');

        // 日志函数
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            logOutput.textContent += logMessage;
            logOutput.scrollTop = logOutput.scrollHeight;
            
            console.log(message);
        }

        // 清除日志
        function clearLogs() {
            logOutput.textContent = '日志已清除...\n';
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            log('页面加载完成，开始初始化微信登录模块...');
            
            try {
                // 创建微信登录实例
                wechatLogin = new WeChatLoginModule({
                    apiBaseUrl: 'https://aimorelogybackend.site'
                });
                
                // 渲染到容器
                const loginContainer = document.getElementById('wechat-login-container');
                wechatLogin.render(loginContainer);
                
                log('微信登录模块初始化成功');
                
                // 监听登录状态变化
                document.addEventListener('wechatLoginStatusChange', function(event) {
                    const { isLoggedIn, userData } = event.detail;
                    log(`登录状态变化: ${isLoggedIn ? '已登录' : '未登录'}`);
                    
                    if (isLoggedIn && userData) {
                        log(`用户信息: ${JSON.stringify({
                            openid: userData.openid,
                            nickname: userData.nickname,
                            level: userData.level,
                            tokenLength: userData.token ? userData.token.length : 0
                        }, null, 2)}`);
                        
                        updateLoginStatus('登录成功！用户: ' + userData.nickname, 'success');
                    } else {
                        updateLoginStatus('用户未登录', 'error');
                    }
                });
                
                // 延迟检查登录状态
                setTimeout(() => {
                    checkCurrentLoginStatus();
                }, 500);
                
            } catch (error) {
                log('初始化失败: ' + error.message);
                updateLoginStatus('初始化失败: ' + error.message, 'error');
            }
        });

        // 更新登录状态显示
        function updateLoginStatus(message, type = 'neutral') {
            const statusEl = document.getElementById('login-status');
            statusEl.textContent = message;
            statusEl.className = `status-info status-${type === 'success' ? 'success' : type === 'error' ? 'error' : 'info-neutral'}`;
        }

        // 检查当前登录状态
        function checkCurrentLoginStatus() {
            log('=== 检查当前登录状态 ===');
            
            try {
                const currentUser = wechatLogin ? wechatLogin.getCurrentUser() : null;
                
                if (currentUser) {
                    log('发现已登录用户:');
                    log(`- OpenID: ${currentUser.openid}`);
                    log(`- 昵称: ${currentUser.nickname}`);
                    log(`- 等级: ${currentUser.level}`);
                    log(`- Token长度: ${currentUser.token ? currentUser.token.length : 0}`);
                    log(`- 过期时间: ${new Date(currentUser.expireTime).toLocaleString()}`);
                    
                    updateLoginStatus(`已登录: ${currentUser.nickname} (${currentUser.level})`, 'success');
                } else {
                    log('当前无登录用户');
                    updateLoginStatus('当前无登录用户', 'error');
                }
                
                // 检查本地存储
                const stored = localStorage.getItem('wechat_user_info');
                if (stored) {
                    try {
                        const userData = JSON.parse(stored);
                        log('本地存储数据:');
                        log(`- Token: ${userData.token ? userData.token.substring(0, 20) + '...' : '无'}`);
                        log(`- 过期时间: ${new Date(userData.expireTime).toLocaleString()}`);
                        log(`- 是否过期: ${userData.expireTime < Date.now() ? '是' : '否'}`);
                    } catch (error) {
                        log('解析本地存储数据失败: ' + error.message);
                    }
                } else {
                    log('本地存储无数据');
                }
                
            } catch (error) {
                log('检查登录状态失败: ' + error.message);
                updateLoginStatus('检查失败: ' + error.message, 'error');
            }
        }

        // 测试Token验证
        async function testTokenValidation() {
            log('=== 测试Token验证 ===');
            
            const currentUser = wechatLogin ? wechatLogin.getCurrentUser() : null;
            if (!currentUser || !currentUser.token) {
                log('没有可用的Token进行测试');
                updateTokenTestStatus('没有可用的Token进行测试', 'error');
                return;
            }
            
            try {
                log('开始验证Token...');
                log(`Token: ${currentUser.token.substring(0, 30)}...`);
                
                const isValid = await wechatLogin.validateToken(currentUser.token);
                
                if (isValid) {
                    log('Token验证成功！');
                    updateTokenTestStatus('Token验证成功！', 'success');
                } else {
                    log('Token验证失败！');
                    updateTokenTestStatus('Token验证失败！', 'error');
                }
                
            } catch (error) {
                log('Token验证异常: ' + error.message);
                updateTokenTestStatus('Token验证异常: ' + error.message, 'error');
            }
        }

        // 更新Token测试状态
        function updateTokenTestStatus(message, type = 'neutral') {
            const statusEl = document.getElementById('token-test-status');
            statusEl.textContent = message;
            statusEl.className = `status-info status-${type === 'success' ? 'success' : type === 'error' ? 'error' : 'info-neutral'}`;
        }

        // 测试Token编码
        function testTokenEncoding() {
            log('=== 测试Token编码 ===');
            
            const currentUser = wechatLogin ? wechatLogin.getCurrentUser() : null;
            if (!currentUser || !currentUser.token) {
                log('没有可用的Token进行测试');
                return;
            }
            
            try {
                const token = currentUser.token;
                log(`原始Token: ${token}`);
                log(`Token长度: ${token.length}`);
                
                // 尝试解码
                try {
                    const decoded = atob(token);
                    log(`解码结果: ${decoded}`);
                    
                    const parts = decoded.split(':');
                    log(`分割结果: ${parts.length} 部分`);
                    if (parts.length === 3) {
                        log(`- OpenID: ${parts[0]}`);
                        log(`- 时间戳: ${parts[1]} (${new Date(parseInt(parts[1])).toLocaleString()})`);
                        log(`- 随机字符串: ${parts[2]}`);
                    }
                    
                    // 重新编码测试
                    const reencoded = btoa(decoded);
                    log(`重新编码: ${reencoded}`);
                    log(`编码一致性: ${token === reencoded ? '一致' : '不一致'}`);
                    
                } catch (decodeError) {
                    log('Base64解码失败: ' + decodeError.message);
                }
                
            } catch (error) {
                log('Token编码测试失败: ' + error.message);
            }
        }

        // 直接验证API测试
        async function testDirectValidation() {
            log('=== 直接API验证测试 ===');
            
            const currentUser = wechatLogin ? wechatLogin.getCurrentUser() : null;
            if (!currentUser || !currentUser.token) {
                log('没有可用的Token进行测试');
                return;
            }
            
            try {
                const token = currentUser.token.trim();
                log(`测试Token: ${token.substring(0, 30)}...`);
                
                const response = await fetch('https://aimorelogybackend.site/validate_token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ token: token })
                });
                
                log(`响应状态: ${response.status}`);
                
                const data = await response.json();
                log(`响应数据: ${JSON.stringify(data, null, 2)}`);
                
                if (data.success && data.valid) {
                    log('直接API验证成功！');
                    updateTokenTestStatus('直接API验证成功！', 'success');
                } else {
                    log('直接API验证失败！');
                    updateTokenTestStatus('直接API验证失败！', 'error');
                }
                
            } catch (error) {
                log('直接API验证异常: ' + error.message);
                updateTokenTestStatus('直接API验证异常: ' + error.message, 'error');
            }
        }

        // 模拟完整登录流程
        function simulateLoginFlow() {
            log('=== 模拟完整登录流程 ===');
            log('请手动进行微信登录，然后观察整个流程...');
            
            // 清除当前登录状态
            if (wechatLogin) {
                wechatLogin.logout();
            }
            
            log('已清除当前登录状态，请重新登录进行测试');
        }

        // 清除登录数据
        function clearLoginData() {
            log('=== 清除登录数据 ===');
            
            try {
                localStorage.removeItem('wechat_user_info');
                log('已清除本地存储数据');
                
                if (wechatLogin) {
                    wechatLogin.logout();
                    log('已调用登录模块退出方法');
                }
                
                updateLoginStatus('登录数据已清除', 'error');
                updateTokenTestStatus('登录数据已清除', 'error');
                
                // 重新渲染登录界面
                setTimeout(() => {
                    if (wechatLogin) {
                        const loginContainer = document.getElementById('wechat-login-container');
                        wechatLogin.render(loginContainer);
                    }
                }, 100);
                
            } catch (error) {
                log('清除登录数据失败: ' + error.message);
            }
        }
    </script>
</body>
</html>