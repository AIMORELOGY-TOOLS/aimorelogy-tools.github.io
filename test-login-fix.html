<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»å½•çŠ¶æ€ä¿®å¤æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .title {
            font-size: 28px;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 16px;
        }

        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 2px solid #f0f0f0;
            border-radius: 12px;
            background: #fafafa;
        }

        .test-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        .login-container {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
        }

        .status-info {
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info-neutral {
            background: #e2e3e5;
            color: #383d41;
            border: 1px solid #d6d8db;
        }

        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #0056b3;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .log-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">ğŸ”§ ç™»å½•çŠ¶æ€ä¿®å¤æµ‹è¯•</div>
            <div class="subtitle">æµ‹è¯•TokenéªŒè¯ä¿®å¤æ˜¯å¦ç”Ÿæ•ˆ</div>
        </div>

        <!-- ç™»å½•æ¨¡å—æµ‹è¯• -->
        <div class="test-section">
            <div class="test-title">1. å¾®ä¿¡ç™»å½•æ¨¡å—æµ‹è¯•</div>
            <div class="login-container" id="wechat-login-container">
                <!-- å¾®ä¿¡ç™»å½•ç»„ä»¶å°†åœ¨è¿™é‡Œæ¸²æŸ“ -->
            </div>
            
            <div class="status-info status-info-neutral" id="login-status">
                ç­‰å¾…ç™»å½•æ¨¡å—åˆå§‹åŒ–...
            </div>

            <button class="btn" onclick="checkCurrentLoginStatus()">æ£€æŸ¥å½“å‰ç™»å½•çŠ¶æ€</button>
            <button class="btn btn-success" onclick="testTokenValidation()">æµ‹è¯•TokenéªŒè¯</button>
            <button class="btn btn-danger" onclick="clearLoginData()">æ¸…é™¤ç™»å½•æ•°æ®</button>
        </div>

        <!-- TokenéªŒè¯æµ‹è¯• -->
        <div class="test-section">
            <div class="test-title">2. TokenéªŒè¯è¯¦ç»†æµ‹è¯•</div>
            <div class="status-info status-info-neutral" id="token-test-status">
                ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•...
            </div>

            <button class="btn" onclick="testTokenEncoding()">æµ‹è¯•Tokenç¼–ç </button>
            <button class="btn" onclick="testDirectValidation()">ç›´æ¥éªŒè¯API</button>
            <button class="btn" onclick="simulateLoginFlow()">æ¨¡æ‹Ÿå®Œæ•´ç™»å½•æµç¨‹</button>
        </div>

        <!-- æ—¥å¿—è¾“å‡º -->
        <div class="test-section">
            <div class="test-title">3. è¯¦ç»†æ—¥å¿—è¾“å‡º</div>
            <div class="log-output" id="log-output">
                æµ‹è¯•æ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º...
            </div>
            <button class="btn" onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>
        </div>
    </div>

    <!-- å¼•å…¥å¾®ä¿¡ç™»å½•æ¨¡å— -->
    <script src="sections/wechat-login.js"></script>
    
    <script>
        let wechatLogin;
        let logOutput = document.getElementById('log-output');

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            logOutput.textContent += logMessage;
            logOutput.scrollTop = logOutput.scrollHeight;
            
            console.log(message);
        }

        // æ¸…é™¤æ—¥å¿—
        function clearLogs() {
            logOutput.textContent = 'æ—¥å¿—å·²æ¸…é™¤...\n';
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–å¾®ä¿¡ç™»å½•æ¨¡å—...');
            
            try {
                // åˆ›å»ºå¾®ä¿¡ç™»å½•å®ä¾‹
                wechatLogin = new WeChatLoginModule({
                    apiBaseUrl: 'https://aimorelogybackend.site'
                });
                
                // æ¸²æŸ“åˆ°å®¹å™¨
                const loginContainer = document.getElementById('wechat-login-container');
                wechatLogin.render(loginContainer);
                
                log('å¾®ä¿¡ç™»å½•æ¨¡å—åˆå§‹åŒ–æˆåŠŸ');
                
                // ç›‘å¬ç™»å½•çŠ¶æ€å˜åŒ–
                document.addEventListener('wechatLoginStatusChange', function(event) {
                    const { isLoggedIn, userData } = event.detail;
                    log(`ç™»å½•çŠ¶æ€å˜åŒ–: ${isLoggedIn ? 'å·²ç™»å½•' : 'æœªç™»å½•'}`);
                    
                    if (isLoggedIn && userData) {
                        log(`ç”¨æˆ·ä¿¡æ¯: ${JSON.stringify({
                            openid: userData.openid,
                            nickname: userData.nickname,
                            level: userData.level,
                            tokenLength: userData.token ? userData.token.length : 0
                        }, null, 2)}`);
                        
                        updateLoginStatus('ç™»å½•æˆåŠŸï¼ç”¨æˆ·: ' + userData.nickname, 'success');
                    } else {
                        updateLoginStatus('ç”¨æˆ·æœªç™»å½•', 'error');
                    }
                });
                
                // å»¶è¿Ÿæ£€æŸ¥ç™»å½•çŠ¶æ€
                setTimeout(() => {
                    checkCurrentLoginStatus();
                }, 500);
                
            } catch (error) {
                log('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                updateLoginStatus('åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
            }
        });

        // æ›´æ–°ç™»å½•çŠ¶æ€æ˜¾ç¤º
        function updateLoginStatus(message, type = 'neutral') {
            const statusEl = document.getElementById('login-status');
            statusEl.textContent = message;
            statusEl.className = `status-info status-${type === 'success' ? 'success' : type === 'error' ? 'error' : 'info-neutral'}`;
        }

        // æ£€æŸ¥å½“å‰ç™»å½•çŠ¶æ€
        function checkCurrentLoginStatus() {
            log('=== æ£€æŸ¥å½“å‰ç™»å½•çŠ¶æ€ ===');
            
            try {
                const currentUser = wechatLogin ? wechatLogin.getCurrentUser() : null;
                
                if (currentUser) {
                    log('å‘ç°å·²ç™»å½•ç”¨æˆ·:');
                    log(`- OpenID: ${currentUser.openid}`);
                    log(`- æ˜µç§°: ${currentUser.nickname}`);
                    log(`- ç­‰çº§: ${currentUser.level}`);
                    log(`- Tokené•¿åº¦: ${currentUser.token ? currentUser.token.length : 0}`);
                    log(`- è¿‡æœŸæ—¶é—´: ${new Date(currentUser.expireTime).toLocaleString()}`);
                    
                    updateLoginStatus(`å·²ç™»å½•: ${currentUser.nickname} (${currentUser.level})`, 'success');
                } else {
                    log('å½“å‰æ— ç™»å½•ç”¨æˆ·');
                    updateLoginStatus('å½“å‰æ— ç™»å½•ç”¨æˆ·', 'error');
                }
                
                // æ£€æŸ¥æœ¬åœ°å­˜å‚¨
                const stored = localStorage.getItem('wechat_user_info');
                if (stored) {
                    try {
                        const userData = JSON.parse(stored);
                        log('æœ¬åœ°å­˜å‚¨æ•°æ®:');
                        log(`- Token: ${userData.token ? userData.token.substring(0, 20) + '...' : 'æ— '}`);
                        log(`- è¿‡æœŸæ—¶é—´: ${new Date(userData.expireTime).toLocaleString()}`);
                        log(`- æ˜¯å¦è¿‡æœŸ: ${userData.expireTime < Date.now() ? 'æ˜¯' : 'å¦'}`);
                    } catch (error) {
                        log('è§£ææœ¬åœ°å­˜å‚¨æ•°æ®å¤±è´¥: ' + error.message);
                    }
                } else {
                    log('æœ¬åœ°å­˜å‚¨æ— æ•°æ®');
                }
                
            } catch (error) {
                log('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥: ' + error.message);
                updateLoginStatus('æ£€æŸ¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æµ‹è¯•TokenéªŒè¯
        async function testTokenValidation() {
            log('=== æµ‹è¯•TokenéªŒè¯ ===');
            
            const currentUser = wechatLogin ? wechatLogin.getCurrentUser() : null;
            if (!currentUser || !currentUser.token) {
                log('æ²¡æœ‰å¯ç”¨çš„Tokenè¿›è¡Œæµ‹è¯•');
                updateTokenTestStatus('æ²¡æœ‰å¯ç”¨çš„Tokenè¿›è¡Œæµ‹è¯•', 'error');
                return;
            }
            
            try {
                log('å¼€å§‹éªŒè¯Token...');
                log(`Token: ${currentUser.token.substring(0, 30)}...`);
                
                const isValid = await wechatLogin.validateToken(currentUser.token);
                
                if (isValid) {
                    log('TokenéªŒè¯æˆåŠŸï¼');
                    updateTokenTestStatus('TokenéªŒè¯æˆåŠŸï¼', 'success');
                } else {
                    log('TokenéªŒè¯å¤±è´¥ï¼');
                    updateTokenTestStatus('TokenéªŒè¯å¤±è´¥ï¼', 'error');
                }
                
            } catch (error) {
                log('TokenéªŒè¯å¼‚å¸¸: ' + error.message);
                updateTokenTestStatus('TokenéªŒè¯å¼‚å¸¸: ' + error.message, 'error');
            }
        }

        // æ›´æ–°Tokenæµ‹è¯•çŠ¶æ€
        function updateTokenTestStatus(message, type = 'neutral') {
            const statusEl = document.getElementById('token-test-status');
            statusEl.textContent = message;
            statusEl.className = `status-info status-${type === 'success' ? 'success' : type === 'error' ? 'error' : 'info-neutral'}`;
        }

        // æµ‹è¯•Tokenç¼–ç 
        function testTokenEncoding() {
            log('=== æµ‹è¯•Tokenç¼–ç  ===');
            
            const currentUser = wechatLogin ? wechatLogin.getCurrentUser() : null;
            if (!currentUser || !currentUser.token) {
                log('æ²¡æœ‰å¯ç”¨çš„Tokenè¿›è¡Œæµ‹è¯•');
                return;
            }
            
            try {
                const token = currentUser.token;
                log(`åŸå§‹Token: ${token}`);
                log(`Tokené•¿åº¦: ${token.length}`);
                
                // å°è¯•è§£ç 
                try {
                    const decoded = atob(token);
                    log(`è§£ç ç»“æœ: ${decoded}`);
                    
                    const parts = decoded.split(':');
                    log(`åˆ†å‰²ç»“æœ: ${parts.length} éƒ¨åˆ†`);
                    if (parts.length === 3) {
                        log(`- OpenID: ${parts[0]}`);
                        log(`- æ—¶é—´æˆ³: ${parts[1]} (${new Date(parseInt(parts[1])).toLocaleString()})`);
                        log(`- éšæœºå­—ç¬¦ä¸²: ${parts[2]}`);
                    }
                    
                    // é‡æ–°ç¼–ç æµ‹è¯•
                    const reencoded = btoa(decoded);
                    log(`é‡æ–°ç¼–ç : ${reencoded}`);
                    log(`ç¼–ç ä¸€è‡´æ€§: ${token === reencoded ? 'ä¸€è‡´' : 'ä¸ä¸€è‡´'}`);
                    
                } catch (decodeError) {
                    log('Base64è§£ç å¤±è´¥: ' + decodeError.message);
                }
                
            } catch (error) {
                log('Tokenç¼–ç æµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }

        // ç›´æ¥éªŒè¯APIæµ‹è¯•
        async function testDirectValidation() {
            log('=== ç›´æ¥APIéªŒè¯æµ‹è¯• ===');
            
            const currentUser = wechatLogin ? wechatLogin.getCurrentUser() : null;
            if (!currentUser || !currentUser.token) {
                log('æ²¡æœ‰å¯ç”¨çš„Tokenè¿›è¡Œæµ‹è¯•');
                return;
            }
            
            try {
                const token = currentUser.token.trim();
                log(`æµ‹è¯•Token: ${token.substring(0, 30)}...`);
                
                const response = await fetch('https://aimorelogybackend.site/validate_token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ token: token })
                });
                
                log(`å“åº”çŠ¶æ€: ${response.status}`);
                
                const data = await response.json();
                log(`å“åº”æ•°æ®: ${JSON.stringify(data, null, 2)}`);
                
                if (data.success && data.valid) {
                    log('ç›´æ¥APIéªŒè¯æˆåŠŸï¼');
                    updateTokenTestStatus('ç›´æ¥APIéªŒè¯æˆåŠŸï¼', 'success');
                } else {
                    log('ç›´æ¥APIéªŒè¯å¤±è´¥ï¼');
                    updateTokenTestStatus('ç›´æ¥APIéªŒè¯å¤±è´¥ï¼', 'error');
                }
                
            } catch (error) {
                log('ç›´æ¥APIéªŒè¯å¼‚å¸¸: ' + error.message);
                updateTokenTestStatus('ç›´æ¥APIéªŒè¯å¼‚å¸¸: ' + error.message, 'error');
            }
        }

        // æ¨¡æ‹Ÿå®Œæ•´ç™»å½•æµç¨‹
        function simulateLoginFlow() {
            log('=== æ¨¡æ‹Ÿå®Œæ•´ç™»å½•æµç¨‹ ===');
            log('è¯·æ‰‹åŠ¨è¿›è¡Œå¾®ä¿¡ç™»å½•ï¼Œç„¶åè§‚å¯Ÿæ•´ä¸ªæµç¨‹...');
            
            // æ¸…é™¤å½“å‰ç™»å½•çŠ¶æ€
            if (wechatLogin) {
                wechatLogin.logout();
            }
            
            log('å·²æ¸…é™¤å½“å‰ç™»å½•çŠ¶æ€ï¼Œè¯·é‡æ–°ç™»å½•è¿›è¡Œæµ‹è¯•');
        }

        // æ¸…é™¤ç™»å½•æ•°æ®
        function clearLoginData() {
            log('=== æ¸…é™¤ç™»å½•æ•°æ® ===');
            
            try {
                localStorage.removeItem('wechat_user_info');
                log('å·²æ¸…é™¤æœ¬åœ°å­˜å‚¨æ•°æ®');
                
                if (wechatLogin) {
                    wechatLogin.logout();
                    log('å·²è°ƒç”¨ç™»å½•æ¨¡å—é€€å‡ºæ–¹æ³•');
                }
                
                updateLoginStatus('ç™»å½•æ•°æ®å·²æ¸…é™¤', 'error');
                updateTokenTestStatus('ç™»å½•æ•°æ®å·²æ¸…é™¤', 'error');
                
                // é‡æ–°æ¸²æŸ“ç™»å½•ç•Œé¢
                setTimeout(() => {
                    if (wechatLogin) {
                        const loginContainer = document.getElementById('wechat-login-container');
                        wechatLogin.render(loginContainer);
                    }
                }, 100);
                
            } catch (error) {
                log('æ¸…é™¤ç™»å½•æ•°æ®å¤±è´¥: ' + error.message);
            }
        }
    </script>
</body>
</html>